{"version":3,"sources":["utils/htmlForFeature.js","utils/formatter.js","components/layers/EnrichedStoresLayer.js","data/sources/enrichedStoresSource.js","components/views/EnrichedStores.js"],"names":["FORMATTER_TYPES","Object","freeze","CURRENCY","NUMBER","formatterFunctions","value","formatted","currencyFormatter","prefix","numberFormatter","DEFAULT_FORMATTER","type","columns","htmlForFeature","title","feature","formatter","includeColumns","showColumnName","Error","propertyNames","keys","properties","supportedTypes","values","includes","isArrayOfStrings","column","available","join","isFormatterValid","includedColumnsAreValid","html","name","generateHtml","propertyName","formatterFunction","v","concat","Array","isArray","length","every","String","DEFAULT_LOCALE","Intl","NumberFormat","maximumFractionDigits","minimumFractionDigits","notation","compactDisplay","format","isNaN","_value","parseLogicalOperation","operation","replace","ENRICHED_STORES_LAYER_ID","EnrichedStoresLayer","enrichedStoresLayer","useSelector","state","carto","layers","source","selectSourceById","cartoLayerProps","useCartoLayerProps","CartoLayer","id","getFillColor","pointRadiusMinPixels","pickable","onHover","info","object","style","MAP_TYPES","TABLE","connection","data","useStyles","makeStyles","enrichedStores","EnrichedStores","dispatch","useDispatch","classes","useEffect","addSource","enrichedStoresSource","addLayer","removeLayer","removeSource","Grid","container","direction","className","item","dataSource","ticks","AggregationTypes","SUM"],"mappings":"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","file":"static/js/13.1a3af7a1.chunk.js","sourcesContent":["import { currencyFormatter, numberFormatter } from 'utils/formatter';\n\nconst FORMATTER_TYPES = Object.freeze({\n  CURRENCY: 'currency',\n  NUMBER: 'number',\n});\n\nconst formatterFunctions = {\n  [FORMATTER_TYPES.CURRENCY](value) {\n    const formatted = currencyFormatter(value);\n    return `${formatted.prefix}${formatted.value}`;\n  },\n  [FORMATTER_TYPES.NUMBER](value) {\n    return numberFormatter(value);\n  },\n};\n\nconst DEFAULT_FORMATTER = {\n  type: '',\n  columns: [],\n};\n\nexport default function htmlForFeature({\n  title,\n  feature,\n  formatter = DEFAULT_FORMATTER,\n  includeColumns = '*',\n  showColumnName = true,\n}) {\n  if (!feature) {\n    throw new Error(`htmlForFeature needs \"info.object\" information`);\n  }\n\n  const propertyNames = Object.keys(feature.properties);\n\n  if (\n    formatter?.type &&\n    formatter?.columns &&\n    !isFormatterValid(propertyNames, formatter)\n  ) {\n    return;\n  }\n\n  if (!includedColumnsAreValid(propertyNames, includeColumns)) {\n    return;\n  }\n\n  let html = '';\n\n  if (title) {\n    html = `<h3 style=\"margin: 0\"><strong>${title}</strong></h3>`;\n  }\n\n  for (const name of propertyNames) {\n    if (\n      name !== 'layerName' &&\n      (includeColumns.includes(name) || includeColumns === '*')\n    ) {\n      if (formatter?.columns.includes(name)) {\n        const formatterFunction = formatterFunctions[formatter.type];\n        html = generateHtml(feature, name, showColumnName, html, formatterFunction);\n      } else {\n        html = generateHtml(feature, name, showColumnName, html);\n      }\n    }\n  }\n\n  return html;\n}\n\nfunction generateHtml(\n  feature,\n  propertyName,\n  showColumnName,\n  html,\n  formatterFunction = (v) => v\n) {\n  return html.concat(\n    `${showColumnName ? `<strong>${propertyName}</strong>: ` : ''}${formatterFunction(\n      feature.properties[propertyName]\n    )}<br/>`\n  );\n}\n\nfunction isFormatterValid(properties, formatter) {\n  const supportedTypes = Object.values(FORMATTER_TYPES);\n\n  if (!supportedTypes.includes(formatter.type)) {\n    throw new Error(\n      `\"${formatter.type}\" is not supported as formatter, use one of \"${supportedTypes}\"`\n    );\n  }\n\n  if (!isArrayOfStrings(formatter.columns)) {\n    throw new Error(`\"formatter.columns\" property needs to be an array of strings`);\n  }\n\n  for (const column of formatter.columns) {\n    if (!properties.includes(column)) {\n      const available = properties.join(', ');\n      throw new Error(\n        `\"formatted.columns\" includes '${column}' but it was not found!. Available cols are [${available}]`\n      );\n    }\n  }\n\n  return true;\n}\n\nfunction includedColumnsAreValid(properties, includeColumns) {\n  if (includeColumns === '*') {\n    return true;\n  }\n\n  if (!isArrayOfStrings(includeColumns)) {\n    throw new Error(\n      `\"includeColumns\" property needs to be an array of existing feature columns or \"*\"`\n    );\n  }\n\n  if (isArrayOfStrings(includeColumns)) {\n    for (const column of includeColumns) {\n      if (!properties.includes(column)) {\n        throw new Error('colums set in \"includeColumns\" should exist in picked feature');\n      }\n    }\n  }\n\n  return true;\n}\n\nfunction isArrayOfStrings(value) {\n  return Array.isArray(value) && value.length && value.every(String);\n}\n","// int-numberformat dependencies (support for ios v13)\nimport '@formatjs/intl-locale/polyfill';\nimport '@formatjs/intl-getcanonicallocales/polyfill';\n\n// int-pluralrules dependencies (support for ios v12)\nimport '@formatjs/intl-pluralrules/polyfill';\nimport '@formatjs/intl-pluralrules/locale-data/en';\n\n/*\n  Note: `notation` & `compactDisplay` properties are not supported yet by Safari.\n  Those require the use of a polyfill: https://www.npmjs.com/package/@formatjs/intl-numberformat\n*/\nimport '@formatjs/intl-numberformat/polyfill';\nimport '@formatjs/intl-numberformat/locale-data/en';\n\nconst DEFAULT_LOCALE = 'en-US';\n\nexport const currencyFormatter = (value) => {\n  return {\n    prefix: '$',\n    value: Intl.NumberFormat(DEFAULT_LOCALE, {\n      maximumFractionDigits: 2,\n      minimumFractionDigits: 2,\n      notation: 'compact',\n      compactDisplay: 'short',\n    }).format(isNaN(value) ? 0 : value),\n  };\n};\n\nexport const numberFormatter = (value) => {\n  const _value = parseLogicalOperation(value);\n  return (\n    _value.operation +\n    Intl.NumberFormat(DEFAULT_LOCALE, {\n      maximumFractionDigits: 1,\n      minimumFractionDigits: 0,\n      notation: 'compact',\n      compactDisplay: 'short',\n    }).format(_value.value)\n  );\n};\n\nconst parseLogicalOperation = (value) => {\n  if (!isNaN(value)) return { value, operation: '' };\n\n  try {\n    const _value = value.replace('>', '');\n    return isNaN(_value)\n      ? { value: 0, operation: '' }\n      : { value: _value, operation: '> ' };\n  } catch {\n    throw new Error(`You are using a numberFormatter on a not valid value: ${value}`);\n  }\n};\n","import { useSelector } from 'react-redux';\nimport { CartoLayer } from '@deck.gl/carto';\nimport { selectSourceById } from '@carto/react-redux';\nimport { useCartoLayerProps } from '@carto/react-api';\nimport htmlForFeature from 'utils/htmlForFeature';\n\nexport const ENRICHED_STORES_LAYER_ID = 'enrichedStoresLayer';\n\nexport default function EnrichedStoresLayer() {\n  const { enrichedStoresLayer } = useSelector((state) => state.carto.layers);\n  const source = useSelector((state) => selectSourceById(state, enrichedStoresLayer?.source));\n  const cartoLayerProps = useCartoLayerProps({ source });\n\n  if (enrichedStoresLayer && source) {\n    return new CartoLayer({\n      ...cartoLayerProps,\n      id: ENRICHED_STORES_LAYER_ID,\n      getFillColor: [241, 109, 122],\n      pointRadiusMinPixels: 2,\n      pickable: true,\n      onHover: (info) => {\n        if (info?.object) {\n          info.object = {\n            html: htmlForFeature({ feature: info.object }),\n            style: {},\n          };\n        }\n      },\n    });\n  }\n}\n","import { MAP_TYPES } from '@deck.gl/carto';\n\nconst ENRICHED_STORES_SOURCE_ID = 'enrichedStoresSource';\n\nconst source = {\n  id: ENRICHED_STORES_SOURCE_ID,\n  type: MAP_TYPES.TABLE,\n  connection: 'bqapp',\n  data: 'cartodb-on-gcp-pm-team.atena.UC5enrichedbuffers-w-geom',\n};\n\nexport default source;\n","import { useEffect } from 'react';\nimport enrichedStoresSource from 'data/sources/enrichedStoresSource';\nimport { ENRICHED_STORES_LAYER_ID } from 'components/layers/EnrichedStoresLayer';\nimport { useDispatch } from 'react-redux';\nimport { addLayer, removeLayer, addSource, removeSource } from '@carto/react-redux';\n\nimport { makeStyles } from '@material-ui/core/styles';\nimport { Grid } from '@material-ui/core';\n\nimport { AggregationTypes } from '@carto/react-core';\nimport { HistogramWidget } from '@carto/react-widgets';\n\nconst useStyles = makeStyles(() => ({\n  enrichedStores: {},\n}));\n\nexport default function EnrichedStores() {\n  const dispatch = useDispatch();\n  const classes = useStyles();\n\n  useEffect(() => {\n    dispatch(addSource(enrichedStoresSource));\n\n    dispatch(\n      addLayer({\n        id: ENRICHED_STORES_LAYER_ID,\n        source: enrichedStoresSource.id,\n      })\n    );\n\n    return () => {\n      dispatch(removeLayer(ENRICHED_STORES_LAYER_ID));\n      dispatch(removeSource(enrichedStoresSource.id));\n    };\n  }, [dispatch]);\n\n  // [hygen] Add useEffect\n\n  return (\n    <Grid container direction='column' className={classes.enrichedStores}>\n      <Grid item>\n        <div>\n          <HistogramWidget\n              id='populationByStore'\n              title='Store clusters by population'\n              dataSource={enrichedStoresSource.id}\n              ticks={[2000,5000,10000,20000]}\n              column='population'\n              operation={AggregationTypes.SUM}\n            />\n        </div>\n      </Grid>\n    </Grid>\n  );\n}\n"],"sourceRoot":""}